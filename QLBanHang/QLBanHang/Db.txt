GO
	USE MASTER
GO
	DROP DATABASE QLBANHANG 
GO
	CREATE DATABASE QLBANHANG
GO
	USE QLBANHANG
GO
	CREATE TABLE MATHANG(
		ID INT IDENTITY PRIMARY KEY,
		MAMH NVARCHAR(MAX),
		TEN NVARCHAR(MAX),
		DONVITINH NVARCHAR(MAX),
		GHICHU NVARCHAR(MAX)
	)
GO
	CREATE TABLE NHANVIEN(
		ID INT IDENTITY PRIMARY KEY,
		MANV NVARCHAR(MAX),
		TEN NVARCHAR(MAX),
		NGAYSINH DATETIME,
		GIOITINH INT, -- 1 : NAM, 0: NU
		QUEQUAN NVARCHAR(MAX),
		SDT NVARCHAR(MAX),
		TAIKHOAN NVARCHAR(MAX),
		MATKHAU NVARCHAR(MAX),
		QUYEN INT -- 1: admin, 0: nhan vien
	)
GO
	CREATE TABLE KHO(
		ID INT IDENTITY PRIMARY KEY,
		MATHANGID INT,
			FOREIGN KEY (MATHANGID) REFERENCES MATHANG(ID),
		SOLUONG INT
	)
GO
	CREATE TABLE PHIEUNHAP(
		ID INT IDENTITY PRIMARY KEY,
		NHANVIENID INT,
			FOREIGN KEY (NHANVIENID) REFERENCES NHANVIEN(ID),
		NGAY DATETIME,
		DIADIEM NVARCHAR(MAX),
		TONGTIEN INT
	)
GO
	CREATE TABLE CHITIETNHAP(
		ID INT IDENTITY PRIMARY KEY,
		PHIEUNHAPID INT,
			FOREIGN KEY (PHIEUNHAPID) REFERENCES PHIEUNHAP(ID),
		MATHANGID INT,
			FOREIGN KEY (MATHANGID) REFERENCES MATHANG(ID),
		SOLUONG INT,
		DONGIA INT,
		THANHTIEN INT
	)
GO
	CREATE TABLE HOADONBAN(
		ID INT IDENTITY PRIMARY KEY,
		NHANVIENID INT,
			FOREIGN KEY (NHANVIENID) REFERENCES NHANVIEN(ID),
		NGAY DATETIME,
		TONGTIEN INT
	)
GO
	CREATE TABLE CHITIETXUAT(
		ID INT IDENTITY PRIMARY KEY,
		HOADONBANID INT,
			FOREIGN KEY (HOADONBANID) REFERENCES HOADONBAN(ID),
		MATHANGID INT,
			FOREIGN KEY (MATHANGID) REFERENCES MATHANG(ID),
		SOLUONG INT,
		GIABAN INT,
		THANHTIEN INT
	)
GO
--- FUNCTION ---
	CREATE FUNCTION TONTAITAIKHOAN(@TENDANGNHAP NVARCHAR(100), @MATKHAU NVARCHAR(100))
	RETURNS INT 
	AS
	BEGIN
		DECLARE @ANS INT

		SELECT @ANS=COUNT(*)
		FROM NHANVIEN TK 
		WHERE TK.TAIKHOAN=@TENDANGNHAP AND TK.MATKHAU=@MATKHAU
		
		RETURN @ANS
	END
GO
--- PROCEDURE --
	CREATE PROC DOIMATKHAU(@ID INT, @MATKHAUMOI NVARCHAR(100))
	AS
	BEGIN
		UPDATE NHANVIEN 
		SET MATKHAU=@MATKHAUMOI
		WHERE ID=@ID
	END
GO  
--- TRIGGER ---
	CREATE TRIGGER TRIG_XOANHANVIEN ON NHANVIEN INSTEAD OF DELETE
	AS 
	BEGIN
		DECLARE @MA INT 
		SELECT @MA = ID FROM DELETED 

		DELETE FROM PHIEUNHAP WHERE NHANVIENID = @MA 
		DELETE FROM HOADONBAN WHERE NHANVIENID = @MA
	END
GO
	CREATE TRIGGER TRIG_XOAMATHANG ON MATHANG INSTEAD OF DELETE
	AS
	BEGIN
		DECLARE @MA INT 
		SELECT @MA = ID FROM DELETED 

		DELETE FROM KHO WHERE MATHANGID = @MA 
		DELETE FROM CHITIETNHAP WHERE MATHANGID = @MA
		DELETE FROM CHITIETXUAT WHERE MATHANGID = @MA 
	END
GO
	CREATE TRIGGER TRIG_XOAPHIEUNHAP ON PHIEUNHAP INSTEAD OF DELETE 
	AS 
	BEGIN
		DECLARE @MA INT 
		SELECT @MA = ID FROM DELETED 

		DELETE FROM CHITIETNHAP WHERE PHIEUNHAPID = @MA
	END
GO
	CREATE TRIGGER TRIG_XOAHOADONBAN ON HOADONBAN INSTEAD OF DELETE 
	AS
	BEGIN
		DECLARE @MA INT 
		SELECT @MA = ID FROM DELETED 

		DELETE FROM CHITIETXUAT WHERE HOADONBANID = @MA 
	END
GO
	CREATE TRIGGER TRIG_THEMMATHANG ON MATHANG FOR INSERT 
	AS
	BEGIN
		DECLARE @MA INT 
		SELECT @MA = ID FROM INSERTED 
		
		INSERT INTO KHO(MATHANGID,SOLUONG) VALUES(@MA, 0)
	END
GO
	CREATE TRIGGER TRIG_THEMCHITIETNHAP ON CHITIETNHAP FOR INSERT 
	AS
	BEGIN
		DECLARE @MA INT, @SLTHEM INT 
		SELECT @MA = MATHANGID,  @SLTHEM = SOLUONG FROM INSERTED
		
		UPDATE KHO SET SOLUONG = SOLUONG + @SLTHEM WHERE MATHANGID = @MA
	END
GO
	CREATE TRIGGER TRIG_THEMCHITIETXUAT ON CHITIETXUAT FOR INSERT 
	AS
	BEGIN
		DECLARE @MA INT, @SLXOA INT 
		SELECT @MA = MATHANGID,  @SLXOA = SOLUONG FROM INSERTED
		
		UPDATE KHO SET SOLUONG = SOLUONG - @SLXOA WHERE MATHANGID = @MA
	END
GO
--- VIEW ---
	CREATE VIEW VIEW_KHO
	AS
	SELECT mh.TEN as TEN, mh.DONVITINH dvt, kh.SoLuong as SoLuong 
	FROM KHO kh, MATHANG mh
	WHERE kh.MATHANGID = mh.ID

GO
--- INSERT DU LIEU MAU ---
	INSERT INTO NHANVIEN(MANV,TEN,NGAYSINH,GIOITINH,QUEQUAN,SDT,TAIKHOAN, MATKHAU, QUYEN) 
			VALUES('NV01',N'Nguyễn Văn Hải','9-3-1993',1,N'Huyện Bố Trạch Tỉnh Quảng Bình','0912345678','admin','1',1)
GO

SELECT * FROM VIEW_KHO